# Cloudflare Pages Deployment Guide

## 1. Prerequisites
- A Cloudflare account
- A GitHub repository containing this project

## 2. Project Configuration Updates (Already Applied)
- **Static Export**: `next.config.mjs` has been updated with `output: 'export'`.
- **WASM Headers**: `public/_headers` has been created with `Cross-Origin-Opener-Policy` and `Cross-Origin-Embedder-Policy` to ensure WASM threading works correctly.
- **Large Assets**: Model files and WASM data are now fetched from Hugging Face CDN to avoid the 25MB file limit.

## 3. Deployment Steps

1. **Push to GitHub**: Commit and push your changes to your repository.
2. **Create Project in Cloudflare**:
   - Go to Cloudflare Dashboard > Pages.
   - Click "Connect to Git".
   - Select your repository.

3. **Build Settings**:
   - **Framework Preset**: `Next.js` (Static HTML Export)
   - **Build Command**: `npm run build`
   - **Output Directory**: `out`

4. **Environment Variables**:
   In the setup screen (or later in Settings > Environment Variables), add:
   - `NEXT_PUBLIC_WHISPER_SERVER_URL`: The WebSocket URL of your WhisperLive backend (e.g., `wss://api.yourdomain.com`).
     - *Note: For initial testing without a backend, you can leave this, but the Online mode will fail to connect and default to offline or show error.*

## 4. Architecture Notes

- **Hybrid Mode**: The app now automatically detects network status.
    - **Online**: Uses `useOnlineWhisper` to connect to your WebSocket server.
    - **Offline**: Uses `useOfflineWhisper` (Sherpa-ONNX WASM) running locally in the browser.
- **SSL Requirement**: Since Cloudflare Pages uses HTTPS, your WebSocket backend MUST use `wss://` (Secure WebSocket). Browsers will block insecure `ws://` connections from an HTTPS page.

## 5. Custom Domain Setup (1.dotalk.dpdns.org)

To bind your domain `1.dotalk.dpdns.org` to this Cloudflare Pages project:

1.  **Cloudflare Pages Dashboard**:
    -   Go to your Pages project -> **Custom Domains** tab.
    -   Click **Set up a custom domain**.
    -   Enter `1.dotalk.dpdns.org` and click **Continue**.

2.  **DNS Configuration (at your DNS Provider)**:
    -   Cloudflare will ask you to update your DNS records.
    -   Since `dpdns.org` looks like a Dynamic DNS or a specific DNS service, you need to go to where you manage `1.dotalk.dpdns.org`.
    -   **Add a CNAME Record**:
        -   **Name/Host**: `1.dotalk` (if managing `dpdns.org` zone) or `@` (if managing specific `1.dotalk.dpdns.org` zone).
        -   **Target/Value**: `your-project-name.pages.dev` (The copy-paste value Cloudflare gives you).
    -   *Note*: If Cloudflare manages the DNS for `dpdns.org` (Full Setup), it will be automatic. If `dpdns.org` is hosted elsewhere (External DNS), you must manually add the CNAME.

3.  **Verification**:
    -   Cloudflare will verify the DNS record. Once active, `https://1.dotalk.dpdns.org` will point to your app.
    -   SSL certificates are automatically generated by Cloudflare.
